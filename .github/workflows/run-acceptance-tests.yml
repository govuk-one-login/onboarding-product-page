name: Acceptance tests

on:
  workflow_call:
    inputs:
      environment: { required: true, type: string }

permissions: { }
concurrency: acceptance-test-${{ inputs.environment }}-${{ github.head_ref || github.ref_name }}

defaults:
  run:
    shell: bash

jobs:
  run-acceptance-tests:
    name: Acceptance
    runs-on: ubuntu-latest
    steps:
      - name: Pull repository
        uses: actions/checkout@v3

      - name: Install Node
        uses: actions/setup-node@v3
        with:
          cache: npm

      - name: Install Node dependencies
        run: npm install --include-workspace-root

      - name: Run cucumber tests
        id: run-tests
        shell: bash
        timeout-minutes: 10
        env:
          REPORT: ${{ runner.temp }}/acceptance-tests.report
          HOST: http://localhost:3000
          #STUB_API: true
        run: |
          shopt -s globstar
          features=(features/**/*.feature)
          
          npm install --prefix /express
          npm run build-express --prefix /express
          
          cd .. && npm run local > /dev/null &
          
          while ! curl --output /dev/null --silent --head --fail $HOST; do sleep 1 && echo -n .; done;
          
          for feature in "${features[@]}"; do
            [[ ${idx:-} ]] && idx=$((idx + 1)) && echo | tee heading || idx=1
            echo "#--- [$idx/${#features[@]}] ${feature#*/} ---#" | tee -a heading && echo >> heading
            npm run cucumber -- --format summary:results "$feature" || cat heading results >> "$REPORT"
          done
          
          [[ -s $REPORT ]] && exit 1 || exit 0
